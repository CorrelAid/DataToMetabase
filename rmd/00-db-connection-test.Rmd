---
title: "R Notebook"
---

```{r}
library(tidyverse)
```

## Load Penguin Data (Local Copy)

Loading the penguin data requires the package
`palmerpenguins`, which can be installed using
`install.packages("palmerpenguins")`.

```{r}
data_local_raw <- palmerpenguins::penguins
```

```{r}
head(data_local_raw)
```

## Example Aggergations

### Simple Group By / Count

```{r}
example_view_simple <- data_local_raw %>%
  group_by(island) %>%
  count()
```

### Faceting, a list of Group/Counts, Split by Island

```{r}
example_view_facets <- data_local_raw %>%
  group_by(island) %>%
  group_map(~ group_by(., species) %>% count())

example_view_facets
```

## Connect to DB

```{r}
library(DBI)
library(RPostgres)
library(readr)

db_name <- Sys.getenv("COOLIFY_DB")
db_host <- Sys.getenv("COOLIFY_HOST")
db_port <- Sys.getenv("COOLIFY_PORT")
db_user <- Sys.getenv("COOLIFY_USER")
db_password <- Sys.getenv("COOLIFY_PASSWORD")

# create connection
con <- DBI::dbConnect(
  drv = RPostgres::Postgres(),
  host = db_host,
  port = db_port,
  dbname = db_name,
  user = db_user,
  password = db_password
)
```

### Get existing table names from DB

```{r}
(db_tables <- DBI::dbListTables(con))
```

### Write Local Copy of Pengunis Data to Remote DB

> ! only do so if table does not exist in remote DB !

```{r}
if (!"penguins" %in% db_tables) {
  print("Writing table `penguins` to DB")
  DBI::dbWriteTable(con, name = "penguins", value = data_local_raw)
} else {
  print("Skipping. table `penguins` already exists in DB")
}
```

### Read remote Penguins data from DB

```{r}
data_remote_raw <- DBI::dbReadTable(con, "penguins")

head(data_remote_raw)
```

### Compare local and remote data with `waldo`

```{r}
waldo::compare(data_local_raw, data_remote_raw)
```

## Important: Disconnect from DB

```{r}
DBI::dbDisconnect(con)
```
